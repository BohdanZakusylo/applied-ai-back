name: Run fastapi endpoints tests

on: 
  pull_request:
    branches:
      - development
  push:
    branches:
      - development

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: "Create .env file"
        run: |
          echo "POSTGRES_USER=testUser" >> .env
          echo "POSTGRES_PASSWORD=testPassword" >> .env
          echo "POSTGRES_DB=testPostgres" >> .env
          echo "GPT_API_KEY=${{ secrets.GPT_API_KEY }}" >> .env
          echo "ASS_ID=${{ secrets.ASS_ID }}" >> .env  
          echo "PGURL=${{ secrets.PGURL }}" >> .env  

      - name: "Create private and public keys"
        run: |
          mkdir -p etc/secrets
          echo "${{ secrets.PUB_KEY }}" > etc/secrets/public_key.pem
          echo "${{ secrets.PRVT_KEY }}" > etc/secrets/private_key.pem

      - name: Build Docker image
        run: docker compose up --build -d

      - name: Run container
        run: docker exec fastapi-app python -m pytest testing/ -v -p no:warnings
      
      - name: Shutdown Docker containers
        run: docker compose down